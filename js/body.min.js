/*
* Javascript to show and hide cookie banner using localstroage
*/

/**
 * Shows the Cookie banner
 */
const showCookieBanner = () => {
  const cookieBanner = document.getElementsByClassName('nk-cookie-banner')[0];
  cookieBanner.style.display = 'block';
};

/**
 * Hides the Cookie banner and saves the value to localstorage
 */
const hideCookieBanner = () => {
  localStorage.setItem('web_dev_isCookieAccepted', 'yes');

  const cookieBanner = document.getElementsByClassName('nk-cookie-banner')[0];
  cookieBanner.style.display = 'none';
};

/**
 * Checks the localstorage and shows Cookie banner based on it.
 */
const initializeCookieBanner = () => {
  const isCookieAccepted = localStorage.getItem('web_dev_isCookieAccepted');
  if (isCookieAccepted === null) {
    localStorage.clear();
    localStorage.setItem('web_dev_isCookieAccepted', 'no');
    showCookieBanner();
  }
  if (isCookieAccepted === 'no') {
    showCookieBanner();
  }
};

// Assigning values to window object
$(document).ready(initializeCookieBanner());
// window.onload = initializeCookieBanner();
window.nk_hideCookieBanner = hideCookieBanner;

$(document).ready(() => {
  $('#fullScreenButton')
      .click(() => {
        if (screenfull.isEnabled) {
          screenfull.toggle();
          $('#fullscreen').removeAttr('class');
          $('#fullscreen').attr('class',
  screenfull.isFullscreen ? 'bi bi-fullscreen':'bi bi-fullscreen-exit');
        } else {
          alert('Your browser doesn\'t support full screen');
        }
        if (screenfull.isEnabled) {
          screenfull.on('change', () => {
            console.log('Am I fullscreen?',
          screenfull.isFullscreen ? 'Yes' : 'No');
          });
        }
      });
});


let pagesIndex, searchIndex;
const MAX_SUMMARY_LENGTH = 200;
const SENTENCE_BOUNDARY_REGEX = /\b\.\s/gm;
const WORD_REGEX = /\b(\w*)[\W|\s|\b]?/gm;

async function initSearchIndex() {
  try {
    const response = await fetch("/index.json");
    pagesIndex = await response.json();
    searchIndex = lunr(function () {
      this.field("title");
      this.field("categories");
      this.field("content");
      this.ref("href");
      pagesIndex.forEach((page) => this.add(page));
    });
  } catch (e) {
    console.log(e);
  }
}

function searchBoxFocused() {
  document.querySelector(".search-container").classList.add("focused");
  document
    .getElementById("search")
    .addEventListener("focusout", () => searchBoxFocusOut());
}

function searchBoxFocusOut() {
  document.querySelector(".search-container").classList.remove("focused");
}

function handleSearchQuery(event) {
  event.preventDefault();
  const query = document.getElementById("search").value.trim().toLowerCase();
  if (!query) {
    displayErrorMessage("Please enter a search term");
    return;
  }
  const results = searchSite(query);
  if (!results.length) {
    displayErrorMessage("Your search returned no results");
    return;
  }
  renderSearchResults(query, results);
}

function displayErrorMessage(message) {
  document.querySelector(".search-error-message").innerHTML = message;
  document.querySelector(".search-container").classList.remove("focused");
  document.querySelector(".search-error").classList.remove("hide-element");
  document.querySelector(".search-error").classList.add("fade");
}

function removeAnimation() {
  this.classList.remove("fade");
  this.classList.add("hide-element");
  document.querySelector(".search-container").classList.add("focused");
}

function searchSite(query) {
  const originalQuery = query;
  query = getLunrSearchQuery(query);
  let results = getSearchResults(query);
  return results.length
    ? results
    : query !== originalQuery
    ? getSearchResults(originalQuery)
    : [];
}

function getLunrSearchQuery(query) {
  const searchTerms = query.split(" ");
  if (searchTerms.length === 1) {
    return query;
  }
  query = "";
  for (const term of searchTerms) {
    query += `+${term} `;
  }
  return query.trim();
}

function getSearchResults(query) {
  return searchIndex.search(query).flatMap((hit) => {
    if (hit.ref == "undefined") return [];
    let pageMatch = pagesIndex.filter((page) => page.href === hit.ref)[0];
    pageMatch.score = hit.score;
    return [pageMatch];
  });
}

function renderSearchResults(query, results) {
  clearSearchResults();
  updateSearchResults(query, results);
  showSearchResults();
  scrollToTop();
}

function clearSearchResults() {
  const results = document.querySelector(".search-results ul");
  while (results.firstChild) results.removeChild(results.firstChild);
}

function updateSearchResults(query, results) {
  document.getElementById("query").innerHTML = query;
  document.querySelector(".search-results ul").innerHTML = results
    .map(
      (hit) => `
    <li class="search-result-item" data-score="${hit.score.toFixed(2)}">
      <a href="${hit.href}" class="search-result-page-title">${hit.title}</a>
      <p>${createSearchResultBlurb(query, hit.content)}</p>
    </li>
    `
    )
    .join("");
  const searchResultListItems = document.querySelectorAll(".search-results ul li");
  document.getElementById("results-count").innerHTML = searchResultListItems.length;
  document.getElementById("results-count-text").innerHTML =
    searchResultListItems.length > 1 ? "results" : "result";
  searchResultListItems.forEach(
    (li) => (li.firstElementChild.style.color = getColorForSearchResult(li.dataset.score))
  );
}

function createSearchResultBlurb(query, pageContent) {
  const searchQueryRegex = new RegExp(createQueryStringRegex(query), "gmi");
  const searchQueryHits = Array.from(
    pageContent.matchAll(searchQueryRegex),
    (m) => m.index
  );
  const sentenceBoundaries = Array.from(
    pageContent.matchAll(SENTENCE_BOUNDARY_REGEX),
    (m) => m.index
  );
  let searchResultText = "";
  let lastEndOfSentence = 0;
  for (const hitLocation of searchQueryHits) {
    if (hitLocation > lastEndOfSentence) {
      for (let i = 0; i < sentenceBoundaries.length; i++) {
        if (sentenceBoundaries[i] > hitLocation) {
          const startOfSentence = i > 0 ? sentenceBoundaries[i - 1] + 1 : 0;
          const endOfSentence = sentenceBoundaries[i];
          lastEndOfSentence = endOfSentence;
          parsedSentence = pageContent.slice(startOfSentence, endOfSentence).trim();
          searchResultText += `${parsedSentence} ... `;
          break;
        }
      }
    }
    const searchResultWords = tokenize(searchResultText);
    const pageBreakers = searchResultWords.filter((word) => word.length > 50);
    if (pageBreakers.length > 0) {
      searchResultText = fixPageBreakers(searchResultText, pageBreakers);
    }
    if (searchResultWords.length >= MAX_SUMMARY_LENGTH) break;
  }
  return ellipsize(searchResultText, MAX_SUMMARY_LENGTH).replace(
    searchQueryRegex,
    "<strong>$&</strong>"
  );
}

function createQueryStringRegex(query) {
  return query.split(" ").length == 1 ? `(${query})` : `(${query.split(" ").join("|")})`;
}

function tokenize(input) {
  const wordMatches = Array.from(input.matchAll(WORD_REGEX), (m) => m);
  return wordMatches.map((m) => ({
    word: m[0],
    start: m.index,
    end: m.index + m[0].length,
    length: m[0].length,
  }));
}

function fixPageBreakers(input, largeWords) {
  largeWords.forEach((word) => {
    const chunked = chunkify(word.word, 20);
    input = input.replace(word.word, chunked);
  });
  return input;
}

function chunkify(input, chunkSize) {
  let output = "";
  let totalChunks = (input.length / chunkSize) | 0;
  let lastChunkIsUneven = input.length % chunkSize > 0;
  if (lastChunkIsUneven) {
    totalChunks += 1;
  }
  for (let i = 0; i < totalChunks; i++) {
    let start = i * chunkSize;
    let end = start + chunkSize;
    if (lastChunkIsUneven && i === totalChunks - 1) {
      end = input.length;
    }
    output += input.slice(start, end) + " ";
  }
  return output;
}

function ellipsize(input, maxLength) {
  const words = tokenize(input);
  if (words.length <= maxLength) {
    return input;
  }
  return input.slice(0, words[maxLength].end) + "...";
}

function showSearchResults() {
  document.querySelector(".primary").classList.add("hide-element");
  document.querySelector(".search-results").classList.remove("hide-element");
  document.getElementById("site-search").classList.add("expanded");
  document
    .getElementById("clear-search-results-sidebar")
    .classList.remove("hide-element");
}

function scrollToTop() {
  const toTopInterval = setInterval(function () {
    const supportedScrollTop =
      document.body.scrollTop > 0 ? document.body : document.documentElement;
    if (supportedScrollTop.scrollTop > 0) {
      supportedScrollTop.scrollTop = supportedScrollTop.scrollTop - 50;
    }
    if (supportedScrollTop.scrollTop < 1) {
      clearInterval(toTopInterval);
    }
  }, 10);
}

function getColorForSearchResult(score) {
  const warmColorHue = 171;
  const coolColorHue = 212;
  return adjustHue(warmColorHue, coolColorHue, score);
}

function adjustHue(hue1, hue2, score) {
  if (score > 3) return `hsl(${hue1}, 100%, 50%)`;
  const hueAdjust = (parseFloat(score) / 3) * (hue1 - hue2);
  const newHue = hue2 + Math.floor(hueAdjust);
  return `hsl(${newHue}, 100%, 50%)`;
}

function handleClearSearchButtonClicked() {
  hideSearchResults();
  clearSearchResults();
  document.getElementById("search").value = "";
}

function hideSearchResults() {
  document.getElementById("clear-search-results-sidebar").classList.add("hide-element");
  document.getElementById("site-search").classList.remove("expanded");
  document.querySelector(".search-results").classList.add("hide-element");
  document.querySelector(".primary").classList.remove("hide-element");
}

initSearchIndex();
document.addEventListener("DOMContentLoaded", function () {
  if (document.getElementById("search-form") != null) {
    const searchInput = document.getElementById("search");
    searchInput.addEventListener("focus", () => searchBoxFocused());
    searchInput.addEventListener("keydown", (event) => {
      if (event.keyCode == 13) handleSearchQuery(event);
    });
    document
      .querySelector(".search-error")
      .addEventListener("animationend", removeAnimation);
    document
      .querySelector(".fa-search")
      .addEventListener("click", (event) => handleSearchQuery(event));
  }
  document
    .querySelectorAll(".clear-search-results")
    .forEach((button) =>
      button.addEventListener("click", () => handleClearSearchButtonClicked())
    );
});

if (!String.prototype.matchAll) {
  String.prototype.matchAll = function (regex) {
    "use strict";
    function ensureFlag(flags, flag) {
      return flags.includes(flag) ? flags : flags + flag;
    }
    function* matchAll(str, regex) {
      const localCopy = new RegExp(regex, ensureFlag(regex.flags, "g"));
      let match;
      while ((match = localCopy.exec(str))) {
        match.index = localCopy.lastIndex - match[0].length;
        yield match;
      }
    }
    return matchAll(this, regex);
  };
}
const searchToggle = (obj, evt) => {
  const container = $(obj).closest('#search-wrapper');
  const icon = $(obj).closest('#search-icon')
  if (!container.hasClass('active')) {
    container.addClass('active');
    icon.addClass('search-icon')
    evt.preventDefault();
  } else if (container.hasClass('active') && $(obj)
      .closest('#input-holder').length == 0) {
    container.removeClass('active');
    icon.removeClass('search-icon')
    // clear input
    container.find('#search-input').val('');
    // clear and hide result container when we press close
    container.find('#result-container').fadeOut(100, () => {
      $(this).empty();
    });
  }
}
/* const submitFn = (obj, evt) => {
  value = $(obj).find('#search-input').val().trim().toLowerCase();
  _html = 'Searching for: ';
  if (!value.length) {
    _html = 'Ehem, I can\'t search nothing';
  } else {
    _html += '<b>' + value + '</b>';
  }
  $(obj).find('#result-container').html('<span>' + _html + '</span>');
  $(obj).find('#result-container').fadeIn(100);
  evt.preventDefault();
} */
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvb2tpZS1iYW5uZXIuanMiLCJmdWxsc2NyZWVuLmpzIiwibHVybi5qcyIsInNlYXJjaC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDelNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImJvZHkubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiogSmF2YXNjcmlwdCB0byBzaG93IGFuZCBoaWRlIGNvb2tpZSBiYW5uZXIgdXNpbmcgbG9jYWxzdHJvYWdlXG4qL1xuXG4vKipcbiAqIFNob3dzIHRoZSBDb29raWUgYmFubmVyXG4gKi9cbmNvbnN0IHNob3dDb29raWVCYW5uZXIgPSAoKSA9PiB7XG4gIGNvbnN0IGNvb2tpZUJhbm5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ25rLWNvb2tpZS1iYW5uZXInKVswXTtcbiAgY29va2llQmFubmVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xufTtcblxuLyoqXG4gKiBIaWRlcyB0aGUgQ29va2llIGJhbm5lciBhbmQgc2F2ZXMgdGhlIHZhbHVlIHRvIGxvY2Fsc3RvcmFnZVxuICovXG5jb25zdCBoaWRlQ29va2llQmFubmVyID0gKCkgPT4ge1xuICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnd2ViX2Rldl9pc0Nvb2tpZUFjY2VwdGVkJywgJ3llcycpO1xuXG4gIGNvbnN0IGNvb2tpZUJhbm5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ25rLWNvb2tpZS1iYW5uZXInKVswXTtcbiAgY29va2llQmFubmVyLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG59O1xuXG4vKipcbiAqIENoZWNrcyB0aGUgbG9jYWxzdG9yYWdlIGFuZCBzaG93cyBDb29raWUgYmFubmVyIGJhc2VkIG9uIGl0LlxuICovXG5jb25zdCBpbml0aWFsaXplQ29va2llQmFubmVyID0gKCkgPT4ge1xuICBjb25zdCBpc0Nvb2tpZUFjY2VwdGVkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3dlYl9kZXZfaXNDb29raWVBY2NlcHRlZCcpO1xuICBpZiAoaXNDb29raWVBY2NlcHRlZCA9PT0gbnVsbCkge1xuICAgIGxvY2FsU3RvcmFnZS5jbGVhcigpO1xuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCd3ZWJfZGV2X2lzQ29va2llQWNjZXB0ZWQnLCAnbm8nKTtcbiAgICBzaG93Q29va2llQmFubmVyKCk7XG4gIH1cbiAgaWYgKGlzQ29va2llQWNjZXB0ZWQgPT09ICdubycpIHtcbiAgICBzaG93Q29va2llQmFubmVyKCk7XG4gIH1cbn07XG5cbi8vIEFzc2lnbmluZyB2YWx1ZXMgdG8gd2luZG93IG9iamVjdFxuJChkb2N1bWVudCkucmVhZHkoaW5pdGlhbGl6ZUNvb2tpZUJhbm5lcigpKTtcbi8vIHdpbmRvdy5vbmxvYWQgPSBpbml0aWFsaXplQ29va2llQmFubmVyKCk7XG53aW5kb3cubmtfaGlkZUNvb2tpZUJhbm5lciA9IGhpZGVDb29raWVCYW5uZXI7XG4iLCIkKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICQoJyNmdWxsU2NyZWVuQnV0dG9uJylcbiAgICAgIC5jbGljaygoKSA9PiB7XG4gICAgICAgIGlmIChzY3JlZW5mdWxsLmlzRW5hYmxlZCkge1xuICAgICAgICAgIHNjcmVlbmZ1bGwudG9nZ2xlKCk7XG4gICAgICAgICAgJCgnI2Z1bGxzY3JlZW4nKS5yZW1vdmVBdHRyKCdjbGFzcycpO1xuICAgICAgICAgICQoJyNmdWxsc2NyZWVuJykuYXR0cignY2xhc3MnLFxuICBzY3JlZW5mdWxsLmlzRnVsbHNjcmVlbiA/ICdiaSBiaS1mdWxsc2NyZWVuJzonYmkgYmktZnVsbHNjcmVlbi1leGl0Jyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYWxlcnQoJ1lvdXIgYnJvd3NlciBkb2VzblxcJ3Qgc3VwcG9ydCBmdWxsIHNjcmVlbicpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzY3JlZW5mdWxsLmlzRW5hYmxlZCkge1xuICAgICAgICAgIHNjcmVlbmZ1bGwub24oJ2NoYW5nZScsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdBbSBJIGZ1bGxzY3JlZW4/JyxcbiAgICAgICAgICBzY3JlZW5mdWxsLmlzRnVsbHNjcmVlbiA/ICdZZXMnIDogJ05vJyk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xufSk7XG5cbiIsImxldCBwYWdlc0luZGV4LCBzZWFyY2hJbmRleDtcbmNvbnN0IE1BWF9TVU1NQVJZX0xFTkdUSCA9IDIwMDtcbmNvbnN0IFNFTlRFTkNFX0JPVU5EQVJZX1JFR0VYID0gL1xcYlxcLlxccy9nbTtcbmNvbnN0IFdPUkRfUkVHRVggPSAvXFxiKFxcdyopW1xcV3xcXHN8XFxiXT8vZ207XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXRTZWFyY2hJbmRleCgpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKFwiL2luZGV4Lmpzb25cIik7XG4gICAgcGFnZXNJbmRleCA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgICBzZWFyY2hJbmRleCA9IGx1bnIoZnVuY3Rpb24gKCkge1xuICAgICAgdGhpcy5maWVsZChcInRpdGxlXCIpO1xuICAgICAgdGhpcy5maWVsZChcImNhdGVnb3JpZXNcIik7XG4gICAgICB0aGlzLmZpZWxkKFwiY29udGVudFwiKTtcbiAgICAgIHRoaXMucmVmKFwiaHJlZlwiKTtcbiAgICAgIHBhZ2VzSW5kZXguZm9yRWFjaCgocGFnZSkgPT4gdGhpcy5hZGQocGFnZSkpO1xuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgY29uc29sZS5sb2coZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gc2VhcmNoQm94Rm9jdXNlZCgpIHtcbiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5zZWFyY2gtY29udGFpbmVyXCIpLmNsYXNzTGlzdC5hZGQoXCJmb2N1c2VkXCIpO1xuICBkb2N1bWVudFxuICAgIC5nZXRFbGVtZW50QnlJZChcInNlYXJjaFwiKVxuICAgIC5hZGRFdmVudExpc3RlbmVyKFwiZm9jdXNvdXRcIiwgKCkgPT4gc2VhcmNoQm94Rm9jdXNPdXQoKSk7XG59XG5cbmZ1bmN0aW9uIHNlYXJjaEJveEZvY3VzT3V0KCkge1xuICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLnNlYXJjaC1jb250YWluZXJcIikuY2xhc3NMaXN0LnJlbW92ZShcImZvY3VzZWRcIik7XG59XG5cbmZ1bmN0aW9uIGhhbmRsZVNlYXJjaFF1ZXJ5KGV2ZW50KSB7XG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gIGNvbnN0IHF1ZXJ5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzZWFyY2hcIikudmFsdWUudHJpbSgpLnRvTG93ZXJDYXNlKCk7XG4gIGlmICghcXVlcnkpIHtcbiAgICBkaXNwbGF5RXJyb3JNZXNzYWdlKFwiUGxlYXNlIGVudGVyIGEgc2VhcmNoIHRlcm1cIik7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IHJlc3VsdHMgPSBzZWFyY2hTaXRlKHF1ZXJ5KTtcbiAgaWYgKCFyZXN1bHRzLmxlbmd0aCkge1xuICAgIGRpc3BsYXlFcnJvck1lc3NhZ2UoXCJZb3VyIHNlYXJjaCByZXR1cm5lZCBubyByZXN1bHRzXCIpO1xuICAgIHJldHVybjtcbiAgfVxuICByZW5kZXJTZWFyY2hSZXN1bHRzKHF1ZXJ5LCByZXN1bHRzKTtcbn1cblxuZnVuY3Rpb24gZGlzcGxheUVycm9yTWVzc2FnZShtZXNzYWdlKSB7XG4gIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuc2VhcmNoLWVycm9yLW1lc3NhZ2VcIikuaW5uZXJIVE1MID0gbWVzc2FnZTtcbiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5zZWFyY2gtY29udGFpbmVyXCIpLmNsYXNzTGlzdC5yZW1vdmUoXCJmb2N1c2VkXCIpO1xuICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLnNlYXJjaC1lcnJvclwiKS5jbGFzc0xpc3QucmVtb3ZlKFwiaGlkZS1lbGVtZW50XCIpO1xuICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLnNlYXJjaC1lcnJvclwiKS5jbGFzc0xpc3QuYWRkKFwiZmFkZVwiKTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlQW5pbWF0aW9uKCkge1xuICB0aGlzLmNsYXNzTGlzdC5yZW1vdmUoXCJmYWRlXCIpO1xuICB0aGlzLmNsYXNzTGlzdC5hZGQoXCJoaWRlLWVsZW1lbnRcIik7XG4gIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuc2VhcmNoLWNvbnRhaW5lclwiKS5jbGFzc0xpc3QuYWRkKFwiZm9jdXNlZFwiKTtcbn1cblxuZnVuY3Rpb24gc2VhcmNoU2l0ZShxdWVyeSkge1xuICBjb25zdCBvcmlnaW5hbFF1ZXJ5ID0gcXVlcnk7XG4gIHF1ZXJ5ID0gZ2V0THVuclNlYXJjaFF1ZXJ5KHF1ZXJ5KTtcbiAgbGV0IHJlc3VsdHMgPSBnZXRTZWFyY2hSZXN1bHRzKHF1ZXJ5KTtcbiAgcmV0dXJuIHJlc3VsdHMubGVuZ3RoXG4gICAgPyByZXN1bHRzXG4gICAgOiBxdWVyeSAhPT0gb3JpZ2luYWxRdWVyeVxuICAgID8gZ2V0U2VhcmNoUmVzdWx0cyhvcmlnaW5hbFF1ZXJ5KVxuICAgIDogW107XG59XG5cbmZ1bmN0aW9uIGdldEx1bnJTZWFyY2hRdWVyeShxdWVyeSkge1xuICBjb25zdCBzZWFyY2hUZXJtcyA9IHF1ZXJ5LnNwbGl0KFwiIFwiKTtcbiAgaWYgKHNlYXJjaFRlcm1zLmxlbmd0aCA9PT0gMSkge1xuICAgIHJldHVybiBxdWVyeTtcbiAgfVxuICBxdWVyeSA9IFwiXCI7XG4gIGZvciAoY29uc3QgdGVybSBvZiBzZWFyY2hUZXJtcykge1xuICAgIHF1ZXJ5ICs9IGArJHt0ZXJtfSBgO1xuICB9XG4gIHJldHVybiBxdWVyeS50cmltKCk7XG59XG5cbmZ1bmN0aW9uIGdldFNlYXJjaFJlc3VsdHMocXVlcnkpIHtcbiAgcmV0dXJuIHNlYXJjaEluZGV4LnNlYXJjaChxdWVyeSkuZmxhdE1hcCgoaGl0KSA9PiB7XG4gICAgaWYgKGhpdC5yZWYgPT0gXCJ1bmRlZmluZWRcIikgcmV0dXJuIFtdO1xuICAgIGxldCBwYWdlTWF0Y2ggPSBwYWdlc0luZGV4LmZpbHRlcigocGFnZSkgPT4gcGFnZS5ocmVmID09PSBoaXQucmVmKVswXTtcbiAgICBwYWdlTWF0Y2guc2NvcmUgPSBoaXQuc2NvcmU7XG4gICAgcmV0dXJuIFtwYWdlTWF0Y2hdO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmVuZGVyU2VhcmNoUmVzdWx0cyhxdWVyeSwgcmVzdWx0cykge1xuICBjbGVhclNlYXJjaFJlc3VsdHMoKTtcbiAgdXBkYXRlU2VhcmNoUmVzdWx0cyhxdWVyeSwgcmVzdWx0cyk7XG4gIHNob3dTZWFyY2hSZXN1bHRzKCk7XG4gIHNjcm9sbFRvVG9wKCk7XG59XG5cbmZ1bmN0aW9uIGNsZWFyU2VhcmNoUmVzdWx0cygpIHtcbiAgY29uc3QgcmVzdWx0cyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuc2VhcmNoLXJlc3VsdHMgdWxcIik7XG4gIHdoaWxlIChyZXN1bHRzLmZpcnN0Q2hpbGQpIHJlc3VsdHMucmVtb3ZlQ2hpbGQocmVzdWx0cy5maXJzdENoaWxkKTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlU2VhcmNoUmVzdWx0cyhxdWVyeSwgcmVzdWx0cykge1xuICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInF1ZXJ5XCIpLmlubmVySFRNTCA9IHF1ZXJ5O1xuICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLnNlYXJjaC1yZXN1bHRzIHVsXCIpLmlubmVySFRNTCA9IHJlc3VsdHNcbiAgICAubWFwKFxuICAgICAgKGhpdCkgPT4gYFxuICAgIDxsaSBjbGFzcz1cInNlYXJjaC1yZXN1bHQtaXRlbVwiIGRhdGEtc2NvcmU9XCIke2hpdC5zY29yZS50b0ZpeGVkKDIpfVwiPlxuICAgICAgPGEgaHJlZj1cIiR7aGl0LmhyZWZ9XCIgY2xhc3M9XCJzZWFyY2gtcmVzdWx0LXBhZ2UtdGl0bGVcIj4ke2hpdC50aXRsZX08L2E+XG4gICAgICA8cD4ke2NyZWF0ZVNlYXJjaFJlc3VsdEJsdXJiKHF1ZXJ5LCBoaXQuY29udGVudCl9PC9wPlxuICAgIDwvbGk+XG4gICAgYFxuICAgIClcbiAgICAuam9pbihcIlwiKTtcbiAgY29uc3Qgc2VhcmNoUmVzdWx0TGlzdEl0ZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5zZWFyY2gtcmVzdWx0cyB1bCBsaVwiKTtcbiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJyZXN1bHRzLWNvdW50XCIpLmlubmVySFRNTCA9IHNlYXJjaFJlc3VsdExpc3RJdGVtcy5sZW5ndGg7XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwicmVzdWx0cy1jb3VudC10ZXh0XCIpLmlubmVySFRNTCA9XG4gICAgc2VhcmNoUmVzdWx0TGlzdEl0ZW1zLmxlbmd0aCA+IDEgPyBcInJlc3VsdHNcIiA6IFwicmVzdWx0XCI7XG4gIHNlYXJjaFJlc3VsdExpc3RJdGVtcy5mb3JFYWNoKFxuICAgIChsaSkgPT4gKGxpLmZpcnN0RWxlbWVudENoaWxkLnN0eWxlLmNvbG9yID0gZ2V0Q29sb3JGb3JTZWFyY2hSZXN1bHQobGkuZGF0YXNldC5zY29yZSkpXG4gICk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVNlYXJjaFJlc3VsdEJsdXJiKHF1ZXJ5LCBwYWdlQ29udGVudCkge1xuICBjb25zdCBzZWFyY2hRdWVyeVJlZ2V4ID0gbmV3IFJlZ0V4cChjcmVhdGVRdWVyeVN0cmluZ1JlZ2V4KHF1ZXJ5KSwgXCJnbWlcIik7XG4gIGNvbnN0IHNlYXJjaFF1ZXJ5SGl0cyA9IEFycmF5LmZyb20oXG4gICAgcGFnZUNvbnRlbnQubWF0Y2hBbGwoc2VhcmNoUXVlcnlSZWdleCksXG4gICAgKG0pID0+IG0uaW5kZXhcbiAgKTtcbiAgY29uc3Qgc2VudGVuY2VCb3VuZGFyaWVzID0gQXJyYXkuZnJvbShcbiAgICBwYWdlQ29udGVudC5tYXRjaEFsbChTRU5URU5DRV9CT1VOREFSWV9SRUdFWCksXG4gICAgKG0pID0+IG0uaW5kZXhcbiAgKTtcbiAgbGV0IHNlYXJjaFJlc3VsdFRleHQgPSBcIlwiO1xuICBsZXQgbGFzdEVuZE9mU2VudGVuY2UgPSAwO1xuICBmb3IgKGNvbnN0IGhpdExvY2F0aW9uIG9mIHNlYXJjaFF1ZXJ5SGl0cykge1xuICAgIGlmIChoaXRMb2NhdGlvbiA+IGxhc3RFbmRPZlNlbnRlbmNlKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlbnRlbmNlQm91bmRhcmllcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAoc2VudGVuY2VCb3VuZGFyaWVzW2ldID4gaGl0TG9jYXRpb24pIHtcbiAgICAgICAgICBjb25zdCBzdGFydE9mU2VudGVuY2UgPSBpID4gMCA/IHNlbnRlbmNlQm91bmRhcmllc1tpIC0gMV0gKyAxIDogMDtcbiAgICAgICAgICBjb25zdCBlbmRPZlNlbnRlbmNlID0gc2VudGVuY2VCb3VuZGFyaWVzW2ldO1xuICAgICAgICAgIGxhc3RFbmRPZlNlbnRlbmNlID0gZW5kT2ZTZW50ZW5jZTtcbiAgICAgICAgICBwYXJzZWRTZW50ZW5jZSA9IHBhZ2VDb250ZW50LnNsaWNlKHN0YXJ0T2ZTZW50ZW5jZSwgZW5kT2ZTZW50ZW5jZSkudHJpbSgpO1xuICAgICAgICAgIHNlYXJjaFJlc3VsdFRleHQgKz0gYCR7cGFyc2VkU2VudGVuY2V9IC4uLiBgO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHNlYXJjaFJlc3VsdFdvcmRzID0gdG9rZW5pemUoc2VhcmNoUmVzdWx0VGV4dCk7XG4gICAgY29uc3QgcGFnZUJyZWFrZXJzID0gc2VhcmNoUmVzdWx0V29yZHMuZmlsdGVyKCh3b3JkKSA9PiB3b3JkLmxlbmd0aCA+IDUwKTtcbiAgICBpZiAocGFnZUJyZWFrZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIHNlYXJjaFJlc3VsdFRleHQgPSBmaXhQYWdlQnJlYWtlcnMoc2VhcmNoUmVzdWx0VGV4dCwgcGFnZUJyZWFrZXJzKTtcbiAgICB9XG4gICAgaWYgKHNlYXJjaFJlc3VsdFdvcmRzLmxlbmd0aCA+PSBNQVhfU1VNTUFSWV9MRU5HVEgpIGJyZWFrO1xuICB9XG4gIHJldHVybiBlbGxpcHNpemUoc2VhcmNoUmVzdWx0VGV4dCwgTUFYX1NVTU1BUllfTEVOR1RIKS5yZXBsYWNlKFxuICAgIHNlYXJjaFF1ZXJ5UmVnZXgsXG4gICAgXCI8c3Ryb25nPiQmPC9zdHJvbmc+XCJcbiAgKTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUXVlcnlTdHJpbmdSZWdleChxdWVyeSkge1xuICByZXR1cm4gcXVlcnkuc3BsaXQoXCIgXCIpLmxlbmd0aCA9PSAxID8gYCgke3F1ZXJ5fSlgIDogYCgke3F1ZXJ5LnNwbGl0KFwiIFwiKS5qb2luKFwifFwiKX0pYDtcbn1cblxuZnVuY3Rpb24gdG9rZW5pemUoaW5wdXQpIHtcbiAgY29uc3Qgd29yZE1hdGNoZXMgPSBBcnJheS5mcm9tKGlucHV0Lm1hdGNoQWxsKFdPUkRfUkVHRVgpLCAobSkgPT4gbSk7XG4gIHJldHVybiB3b3JkTWF0Y2hlcy5tYXAoKG0pID0+ICh7XG4gICAgd29yZDogbVswXSxcbiAgICBzdGFydDogbS5pbmRleCxcbiAgICBlbmQ6IG0uaW5kZXggKyBtWzBdLmxlbmd0aCxcbiAgICBsZW5ndGg6IG1bMF0ubGVuZ3RoLFxuICB9KSk7XG59XG5cbmZ1bmN0aW9uIGZpeFBhZ2VCcmVha2VycyhpbnB1dCwgbGFyZ2VXb3Jkcykge1xuICBsYXJnZVdvcmRzLmZvckVhY2goKHdvcmQpID0+IHtcbiAgICBjb25zdCBjaHVua2VkID0gY2h1bmtpZnkod29yZC53b3JkLCAyMCk7XG4gICAgaW5wdXQgPSBpbnB1dC5yZXBsYWNlKHdvcmQud29yZCwgY2h1bmtlZCk7XG4gIH0pO1xuICByZXR1cm4gaW5wdXQ7XG59XG5cbmZ1bmN0aW9uIGNodW5raWZ5KGlucHV0LCBjaHVua1NpemUpIHtcbiAgbGV0IG91dHB1dCA9IFwiXCI7XG4gIGxldCB0b3RhbENodW5rcyA9IChpbnB1dC5sZW5ndGggLyBjaHVua1NpemUpIHwgMDtcbiAgbGV0IGxhc3RDaHVua0lzVW5ldmVuID0gaW5wdXQubGVuZ3RoICUgY2h1bmtTaXplID4gMDtcbiAgaWYgKGxhc3RDaHVua0lzVW5ldmVuKSB7XG4gICAgdG90YWxDaHVua3MgKz0gMTtcbiAgfVxuICBmb3IgKGxldCBpID0gMDsgaSA8IHRvdGFsQ2h1bmtzOyBpKyspIHtcbiAgICBsZXQgc3RhcnQgPSBpICogY2h1bmtTaXplO1xuICAgIGxldCBlbmQgPSBzdGFydCArIGNodW5rU2l6ZTtcbiAgICBpZiAobGFzdENodW5rSXNVbmV2ZW4gJiYgaSA9PT0gdG90YWxDaHVua3MgLSAxKSB7XG4gICAgICBlbmQgPSBpbnB1dC5sZW5ndGg7XG4gICAgfVxuICAgIG91dHB1dCArPSBpbnB1dC5zbGljZShzdGFydCwgZW5kKSArIFwiIFwiO1xuICB9XG4gIHJldHVybiBvdXRwdXQ7XG59XG5cbmZ1bmN0aW9uIGVsbGlwc2l6ZShpbnB1dCwgbWF4TGVuZ3RoKSB7XG4gIGNvbnN0IHdvcmRzID0gdG9rZW5pemUoaW5wdXQpO1xuICBpZiAod29yZHMubGVuZ3RoIDw9IG1heExlbmd0aCkge1xuICAgIHJldHVybiBpbnB1dDtcbiAgfVxuICByZXR1cm4gaW5wdXQuc2xpY2UoMCwgd29yZHNbbWF4TGVuZ3RoXS5lbmQpICsgXCIuLi5cIjtcbn1cblxuZnVuY3Rpb24gc2hvd1NlYXJjaFJlc3VsdHMoKSB7XG4gIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucHJpbWFyeVwiKS5jbGFzc0xpc3QuYWRkKFwiaGlkZS1lbGVtZW50XCIpO1xuICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLnNlYXJjaC1yZXN1bHRzXCIpLmNsYXNzTGlzdC5yZW1vdmUoXCJoaWRlLWVsZW1lbnRcIik7XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwic2l0ZS1zZWFyY2hcIikuY2xhc3NMaXN0LmFkZChcImV4cGFuZGVkXCIpO1xuICBkb2N1bWVudFxuICAgIC5nZXRFbGVtZW50QnlJZChcImNsZWFyLXNlYXJjaC1yZXN1bHRzLXNpZGViYXJcIilcbiAgICAuY2xhc3NMaXN0LnJlbW92ZShcImhpZGUtZWxlbWVudFwiKTtcbn1cblxuZnVuY3Rpb24gc2Nyb2xsVG9Ub3AoKSB7XG4gIGNvbnN0IHRvVG9wSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7XG4gICAgY29uc3Qgc3VwcG9ydGVkU2Nyb2xsVG9wID1cbiAgICAgIGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wID4gMCA/IGRvY3VtZW50LmJvZHkgOiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7XG4gICAgaWYgKHN1cHBvcnRlZFNjcm9sbFRvcC5zY3JvbGxUb3AgPiAwKSB7XG4gICAgICBzdXBwb3J0ZWRTY3JvbGxUb3Auc2Nyb2xsVG9wID0gc3VwcG9ydGVkU2Nyb2xsVG9wLnNjcm9sbFRvcCAtIDUwO1xuICAgIH1cbiAgICBpZiAoc3VwcG9ydGVkU2Nyb2xsVG9wLnNjcm9sbFRvcCA8IDEpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodG9Ub3BJbnRlcnZhbCk7XG4gICAgfVxuICB9LCAxMCk7XG59XG5cbmZ1bmN0aW9uIGdldENvbG9yRm9yU2VhcmNoUmVzdWx0KHNjb3JlKSB7XG4gIGNvbnN0IHdhcm1Db2xvckh1ZSA9IDE3MTtcbiAgY29uc3QgY29vbENvbG9ySHVlID0gMjEyO1xuICByZXR1cm4gYWRqdXN0SHVlKHdhcm1Db2xvckh1ZSwgY29vbENvbG9ySHVlLCBzY29yZSk7XG59XG5cbmZ1bmN0aW9uIGFkanVzdEh1ZShodWUxLCBodWUyLCBzY29yZSkge1xuICBpZiAoc2NvcmUgPiAzKSByZXR1cm4gYGhzbCgke2h1ZTF9LCAxMDAlLCA1MCUpYDtcbiAgY29uc3QgaHVlQWRqdXN0ID0gKHBhcnNlRmxvYXQoc2NvcmUpIC8gMykgKiAoaHVlMSAtIGh1ZTIpO1xuICBjb25zdCBuZXdIdWUgPSBodWUyICsgTWF0aC5mbG9vcihodWVBZGp1c3QpO1xuICByZXR1cm4gYGhzbCgke25ld0h1ZX0sIDEwMCUsIDUwJSlgO1xufVxuXG5mdW5jdGlvbiBoYW5kbGVDbGVhclNlYXJjaEJ1dHRvbkNsaWNrZWQoKSB7XG4gIGhpZGVTZWFyY2hSZXN1bHRzKCk7XG4gIGNsZWFyU2VhcmNoUmVzdWx0cygpO1xuICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInNlYXJjaFwiKS52YWx1ZSA9IFwiXCI7XG59XG5cbmZ1bmN0aW9uIGhpZGVTZWFyY2hSZXN1bHRzKCkge1xuICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImNsZWFyLXNlYXJjaC1yZXN1bHRzLXNpZGViYXJcIikuY2xhc3NMaXN0LmFkZChcImhpZGUtZWxlbWVudFwiKTtcbiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzaXRlLXNlYXJjaFwiKS5jbGFzc0xpc3QucmVtb3ZlKFwiZXhwYW5kZWRcIik7XG4gIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuc2VhcmNoLXJlc3VsdHNcIikuY2xhc3NMaXN0LmFkZChcImhpZGUtZWxlbWVudFwiKTtcbiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5wcmltYXJ5XCIpLmNsYXNzTGlzdC5yZW1vdmUoXCJoaWRlLWVsZW1lbnRcIik7XG59XG5cbmluaXRTZWFyY2hJbmRleCgpO1xuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIkRPTUNvbnRlbnRMb2FkZWRcIiwgZnVuY3Rpb24gKCkge1xuICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzZWFyY2gtZm9ybVwiKSAhPSBudWxsKSB7XG4gICAgY29uc3Qgc2VhcmNoSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInNlYXJjaFwiKTtcbiAgICBzZWFyY2hJbnB1dC5hZGRFdmVudExpc3RlbmVyKFwiZm9jdXNcIiwgKCkgPT4gc2VhcmNoQm94Rm9jdXNlZCgpKTtcbiAgICBzZWFyY2hJbnB1dC5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCAoZXZlbnQpID0+IHtcbiAgICAgIGlmIChldmVudC5rZXlDb2RlID09IDEzKSBoYW5kbGVTZWFyY2hRdWVyeShldmVudCk7XG4gICAgfSk7XG4gICAgZG9jdW1lbnRcbiAgICAgIC5xdWVyeVNlbGVjdG9yKFwiLnNlYXJjaC1lcnJvclwiKVxuICAgICAgLmFkZEV2ZW50TGlzdGVuZXIoXCJhbmltYXRpb25lbmRcIiwgcmVtb3ZlQW5pbWF0aW9uKTtcbiAgICBkb2N1bWVudFxuICAgICAgLnF1ZXJ5U2VsZWN0b3IoXCIuZmEtc2VhcmNoXCIpXG4gICAgICAuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIChldmVudCkgPT4gaGFuZGxlU2VhcmNoUXVlcnkoZXZlbnQpKTtcbiAgfVxuICBkb2N1bWVudFxuICAgIC5xdWVyeVNlbGVjdG9yQWxsKFwiLmNsZWFyLXNlYXJjaC1yZXN1bHRzXCIpXG4gICAgLmZvckVhY2goKGJ1dHRvbikgPT5cbiAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4gaGFuZGxlQ2xlYXJTZWFyY2hCdXR0b25DbGlja2VkKCkpXG4gICAgKTtcbn0pO1xuXG5pZiAoIVN0cmluZy5wcm90b3R5cGUubWF0Y2hBbGwpIHtcbiAgU3RyaW5nLnByb3RvdHlwZS5tYXRjaEFsbCA9IGZ1bmN0aW9uIChyZWdleCkge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIGZ1bmN0aW9uIGVuc3VyZUZsYWcoZmxhZ3MsIGZsYWcpIHtcbiAgICAgIHJldHVybiBmbGFncy5pbmNsdWRlcyhmbGFnKSA/IGZsYWdzIDogZmxhZ3MgKyBmbGFnO1xuICAgIH1cbiAgICBmdW5jdGlvbiogbWF0Y2hBbGwoc3RyLCByZWdleCkge1xuICAgICAgY29uc3QgbG9jYWxDb3B5ID0gbmV3IFJlZ0V4cChyZWdleCwgZW5zdXJlRmxhZyhyZWdleC5mbGFncywgXCJnXCIpKTtcbiAgICAgIGxldCBtYXRjaDtcbiAgICAgIHdoaWxlICgobWF0Y2ggPSBsb2NhbENvcHkuZXhlYyhzdHIpKSkge1xuICAgICAgICBtYXRjaC5pbmRleCA9IGxvY2FsQ29weS5sYXN0SW5kZXggLSBtYXRjaFswXS5sZW5ndGg7XG4gICAgICAgIHlpZWxkIG1hdGNoO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbWF0Y2hBbGwodGhpcywgcmVnZXgpO1xuICB9O1xufSIsImNvbnN0IHNlYXJjaFRvZ2dsZSA9IChvYmosIGV2dCkgPT4ge1xuICBjb25zdCBjb250YWluZXIgPSAkKG9iaikuY2xvc2VzdCgnI3NlYXJjaC13cmFwcGVyJyk7XG4gIGNvbnN0IGljb24gPSAkKG9iaikuY2xvc2VzdCgnI3NlYXJjaC1pY29uJylcbiAgaWYgKCFjb250YWluZXIuaGFzQ2xhc3MoJ2FjdGl2ZScpKSB7XG4gICAgY29udGFpbmVyLmFkZENsYXNzKCdhY3RpdmUnKTtcbiAgICBpY29uLmFkZENsYXNzKCdzZWFyY2gtaWNvbicpXG4gICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gIH0gZWxzZSBpZiAoY29udGFpbmVyLmhhc0NsYXNzKCdhY3RpdmUnKSAmJiAkKG9iailcbiAgICAgIC5jbG9zZXN0KCcjaW5wdXQtaG9sZGVyJykubGVuZ3RoID09IDApIHtcbiAgICBjb250YWluZXIucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1xuICAgIGljb24ucmVtb3ZlQ2xhc3MoJ3NlYXJjaC1pY29uJylcbiAgICAvLyBjbGVhciBpbnB1dFxuICAgIGNvbnRhaW5lci5maW5kKCcjc2VhcmNoLWlucHV0JykudmFsKCcnKTtcbiAgICAvLyBjbGVhciBhbmQgaGlkZSByZXN1bHQgY29udGFpbmVyIHdoZW4gd2UgcHJlc3MgY2xvc2VcbiAgICBjb250YWluZXIuZmluZCgnI3Jlc3VsdC1jb250YWluZXInKS5mYWRlT3V0KDEwMCwgKCkgPT4ge1xuICAgICAgJCh0aGlzKS5lbXB0eSgpO1xuICAgIH0pO1xuICB9XG59XG4vKiBjb25zdCBzdWJtaXRGbiA9IChvYmosIGV2dCkgPT4ge1xuICB2YWx1ZSA9ICQob2JqKS5maW5kKCcjc2VhcmNoLWlucHV0JykudmFsKCkudHJpbSgpLnRvTG93ZXJDYXNlKCk7XG4gIF9odG1sID0gJ1NlYXJjaGluZyBmb3I6ICc7XG4gIGlmICghdmFsdWUubGVuZ3RoKSB7XG4gICAgX2h0bWwgPSAnRWhlbSwgSSBjYW5cXCd0IHNlYXJjaCBub3RoaW5nJztcbiAgfSBlbHNlIHtcbiAgICBfaHRtbCArPSAnPGI+JyArIHZhbHVlICsgJzwvYj4nO1xuICB9XG4gICQob2JqKS5maW5kKCcjcmVzdWx0LWNvbnRhaW5lcicpLmh0bWwoJzxzcGFuPicgKyBfaHRtbCArICc8L3NwYW4+Jyk7XG4gICQob2JqKS5maW5kKCcjcmVzdWx0LWNvbnRhaW5lcicpLmZhZGVJbigxMDApO1xuICBldnQucHJldmVudERlZmF1bHQoKTtcbn0gKi8iXX0=
